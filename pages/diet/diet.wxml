<view class="container">
  <!-- 按日期分组的记录列表 -->
  <scroll-view class="records-scroll" scroll-y="true">
    <view class="records-list">
      <block wx:for="{{groupedRecords}}" wx:key="date">
        <view class="date-group">
          <view class="date-header">
            <text class="date-text">{{item.dateText}}</text>
            <text class="date-count">{{item.records.length}}条记录</text>
          </view>
          <view class="records-group">
            <view class="record-item" wx:for="{{item.records}}" wx:for-item="record" wx:for-index="recordIndex" wx:key="id">
              <view class="record-content" bindtap="toggleRecordExpand" data-date-index="{{index}}" data-record-index="{{recordIndex}}">
                <!-- 基本信息 -->
                <view class="record-basic">
                  <view class="record-header">
                    <view class="record-title-row">
                      <text class="record-name">{{record.foodName || '饮食记录'}}</text>
                      <text class="record-calories" wx:if="{{record.calories}}">{{record.calories}} 卡</text>
                    </view>
                    <view class="record-meta-row">
                      <text class="record-type">{{record.mealType || '饮食'}}</text>
                      <text class="record-time">{{record.timeText}}</text>
                    </view>
                  </view>
                  
                  <!-- 分量信息 -->
                  <view class="record-quantity" wx:if="{{record.quantity}}">
                    <text class="quantity-text">{{record.quantity}}{{record.unit || '克'}}</text>
                  </view>
                  
                  <!-- 图片展示 -->
                  <view class="record-images" wx:if="{{record.imageList && record.imageList.length > 0}}">
                    <image 
                      class="record-image" 
                      wx:for="{{record.imageList}}" 
                      wx:for-item="img" 
                      wx:key="*this"
                      src="{{img}}" 
                      mode="aspectFill"
                      catchtap="previewImage"
                      data-urls="{{record.imageList}}"
                      data-current="{{img}}"
                    />
                  </view>
                </view>
                
                <!-- 详细信息（展开时显示） -->
                <view class="record-detail" wx:if="{{record.expanded}}">
                  <view class="detail-section" wx:if="{{record.foodCategory}}">
                    <text class="detail-label">食物分类：</text>
                    <text class="detail-value">{{record.foodCategory}}</text>
                  </view>
                  
                  <view class="detail-nutrition" wx:if="{{record.protein || record.carbohydrate || record.fat || record.fiber}}">
                    <view class="nutrition-item" wx:if="{{record.protein}}">
                      <text class="nutrition-label">蛋白质：</text>
                      <text class="nutrition-value">{{record.protein}}g</text>
                    </view>
                    <view class="nutrition-item" wx:if="{{record.carbohydrate}}">
                      <text class="nutrition-label">碳水化合物：</text>
                      <text class="nutrition-value">{{record.carbohydrate}}g</text>
                    </view>
                    <view class="nutrition-item" wx:if="{{record.fat}}">
                      <text class="nutrition-label">脂肪：</text>
                      <text class="nutrition-value">{{record.fat}}g</text>
                    </view>
                    <view class="nutrition-item" wx:if="{{record.fiber}}">
                      <text class="nutrition-label">纤维：</text>
                      <text class="nutrition-value">{{record.fiber}}g</text>
                    </view>
                  </view>
                  
                  <view class="detail-section" wx:if="{{record.notes}}">
                    <text class="detail-label">备注：</text>
                    <text class="detail-value notes-text">{{record.notes}}</text>
                  </view>
                </view>
                
                <!-- 展开/收起指示器 -->
                <view class="expand-indicator">
                  <text class="expand-icon">{{record.expanded ? '▲' : '▼'}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
      
      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{groupedRecords.length === 0}}">
        <text class="empty-text">暂无饮食记录</text>
        <text class="empty-hint">点击右下角按钮快速添加</text>
      </view>
    </view>
  </scroll-view>

  <!-- 快速添加按钮 -->
  <view class="fab" bindtap="showAddModal">
    <text class="fab-icon">+</text>
  </view>

  <!-- 添加记录弹窗 -->
  <view class="modal" wx:if="{{showModal}}" bindtap="hideAddModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">快速添加记录</text>
        <text class="modal-close" bindtap="hideAddModal">×</text>
      </view>
      <view class="modal-body">
        <!-- 图片选择区域 -->
        <view class="image-section">
          <view class="image-list">
            <view class="image-item" wx:for="{{selectedImages}}" wx:key="*this" wx:for-index="idx">
              <image class="preview-image" src="{{item}}" mode="aspectFill" />
              <view class="image-delete" bindtap="deleteImage" data-index="{{idx}}">×</view>
            </view>
            <view class="image-add-btn" bindtap="chooseImage" wx:if="{{selectedImages.length < 9}}">
              <text class="add-icon">+</text>
              <text class="add-text">添加图片</text>
            </view>
          </view>
        </view>

        <!-- 餐次类型选择 -->
        <view class="form-section">
          <text class="form-label">餐次类型</text>
          <view class="meal-type-list">
            <view 
              class="meal-type-item {{mealType === item ? 'active' : ''}}"
              wx:for="{{mealTypes}}"
              wx:key="*this"
              bindtap="selectMealType"
              data-type="{{item}}"
            >
              {{item}}
            </view>
          </view>
        </view>

        <!-- 时间选择 -->
        <view class="form-section">
          <text class="form-label">用餐时间</text>
          <picker mode="time" value="{{recordTime}}" bindchange="onTimeChange">
            <view class="picker-text">{{recordTime || '请选择时间'}}</view>
          </picker>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideAddModal">取消</button>
        <button class="btn-submit" bindtap="submitRecord" disabled="{{selectedImages.length === 0 || !mealType || !recordTime || submitting}}">
          {{submitting ? (uploading ? '上传中...' : '提交中...') : '提交'}}
        </button>
      </view>
    </view>
  </view>
</view>


